<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRUD API Example</title>
    <style>
        #results {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <h1>Courses</h1>
    <form id="course-form">
        <input type="hidden" id="course-id" value="0">
        <label for="course-name">Name:</label>
        <input type="text" id="course-name" required>
        <button type="submit">Save</button>
    </form>
    <div id="results" class="courses"></div>

    <h1>Students</h1>
    <form id="student-form">
        <input type="hidden" id="student-id" value="0">
        <label for="student-name">Name:</label>
        <input type="text" id="student-name" required>
        <label for="student-ra">RA:</label>
        <input type="text" id="student-ra" required>
        <label for="student-curso">Course:</label>
        <select id="student-curso" required>
            <!-- Course options will be populated here -->
        </select>
        <button type="submit">Save</button>
    </form>
    <div id="results" class="students"></div>

    <script>
        const courseForm = document.getElementById('course-form');
        const studentForm = document.getElementById('student-form');

        // Helper function to display courses and students
        function displayResults(results, target) {
            target.innerHTML = '';
            results.forEach(result => {
                const div = document.createElement('div');
                div.textContent = `${result.nome}`;
                div.dataset.id = result.cursoid;
                if (target.classList.contains('courses')) {
                    div.contentEditable = 'true';
                    div.addEventListener('blur', () => updateCourse(div));
                    div.addEventListener('dblclick', (e) => deleteCourse(e, div));
                } else {
                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'Delete';
                    deleteButton.dataset.id = result.alunoID;
                    deleteButton.addEventListener('click', (e) => deleteStudent(e, div));
                    div.appendChild(deleteButton);
                }
                target.appendChild(div);
            });
        }

        // Fetch courses and students on page load
        async function fetchData() {
            try {
                const [coursesResponse, studentsResponse] = await Promise.all([
                    fetch('/cursos'),
                    fetch('/alunos'),
                ]);
                const courses = await coursesResponse.json();
                const students = await studentsResponse.json();

                // Populate course select for students
                const studentCursoSelect = document.getElementById('student-curso');
                courses.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course.cursoid;
                    option.textContent = course.nome;
                    studentCursoSelect.appendChild(option);
                });

                displayResults(courses, document.querySelector('.courses'));
                displayResults(students, document.querySelector('.students'));
            } catch (err) {
                console.error('Error fetching data', err);
            }
        }

        // Create, update, and delete course functions
        async function createCourse(course) {
            try {
                const response = await fetch('/cursos', {
                    method: 'POST',headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(course),
                });
                const result = await response.json();
                return result;
            } catch (err) {
                console.error('Error creating course', err);
            }
        }

        async function updateCourse(div) {
            const id = div.dataset.id;
            const newName = div.textContent;
            try {
                const response = await fetch(`/cursos/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ nome: newName }),
                });
                const result = await response.json();
                div.dataset.id = result.cursoid;
            } catch (err) {
                console.error('Error updating course', err);
            }
        }

        async function deleteCourse(event, div) {
            const id = div.dataset.id;
            try {
                await fetch(`/cursos/${id}`, {
                    method: 'DELETE',
                });
                div.remove();
            } catch (err) {
                console.error('Error deleting course', err);
            }
        }

        // Create, update, and delete student functions
        async function createStudent(student) {
            try {
                const response = await fetch('/alunos', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(student),
                });
                const result = await response.json();
                return result;
            } catch (err) {
                console.error('Error creating student', err);
            }
        }

        async function updateStudent(student) {
            try {
                const response = await fetch(`/alunos/${student.alunoID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(student),
                });
                const result = await response.json();
                return result;
            } catch (err) {
                console.error('Error updating student', err);
            }
        }

        async function deleteStudent(event, div) {
            const id = div.dataset.id;
            try {
                await fetch(`/alunos/${id}`, {
                    method: 'DELETE',
                });
                div.remove();
            } catch (err) {
                console.error('Error deleting student', err);
            }
        }

        // Event listeners for forms
        courseForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('course-id').value;
            const name = document.getElementById('course-name').value;
            const course = { nome: name };
            if (id !== '0') {
                course.cursoid = id;
                await updateCourse(course);
                document.getElementById('course-id').value = '0';
            } else {
                const result = await createCourse(course);
                const div = document.createElement('div');
                div.textContent = `${result.nome}`;
                div.dataset.id = result.cursoid;
                div.contentEditable = 'true';
                div.addEventListener('blur', () => updateCourse(div));
                div.addEventListener('dblclick', (e) => deleteCourse(e, div));
                document.querySelector('.courses').appendChild(div);
            }
            document.getElementById('course-name').value = '';
        });

        studentForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('student-id').value;
            const name = document.getElementById('student-name').value;
            const ra = document.getElementById('student-ra').value;
            const cursoId = document.getElementById('student-curso').value;
const student = {
                nome: name,
                ra: ra,
                cursoId: cursoId,
            };
            if (id !== '0') {
                student.alunoID = id;
                await updateStudent(student);
                document.getElementById('student-id').value = '0';
            } else {
                const result = await createStudent(student);
                const div = document.createElement('div');
                div.textContent = `${result.nome}`;
                div.dataset.id = result.alunoID;
                const deleteButton = document.createElement('button');
                deleteButton.textContent = 'Delete';
                deleteButton.dataset.id = result.alunoID;
                deleteButton.addEventListener('click', (e) => deleteStudent(e, div));
                div.appendChild(deleteButton);
                document.querySelector('.students').appendChild(div);
            }
            document.getElementById('student-name').value = '';
            document.getElementById('student-ra').value = '';
            document.getElementById('student-curso').value = '0';
        });

        fetchData();
    </script>
</body>
</html>